# Как добавлять новые маршруты

Документация по структуре маршрутов на странице `/routes/` и пошаговая инструкция для добавления нового маршрута.

---

## Участвующие файлы

| Файл | Назначение |
|------|------------|
| `site/routes/index.html` | Карточки маршрутов (HTML), легенда общей карты, скрипт с ROUTE_INFO, ROUTE_ORDER, PALETTE |
| `site/routes/routes-maps.js` | Данные для карт каждого маршрута: центр, зум, трек (точки), waypoints (маркеры с подписями) |
| `site/routes/build-route-geometries.js` | Треки для OSRM: последовательность точек маршрута (ключ → массив [lat, lng]) |
| `site/routes/route-geometries.js` | **Генерируется скриптом** — полилинии по дорогам (OSRM). Вручную не править. |

---

## Сортировка на странице

- Маршруты на странице и в легенде общей карты упорядочены по **продолжительности** (от коротких к длинным).
- **Исключение:** маршрут «Горнолыжное кольцо Сибири» (`ski_ring`) **всегда остаётся последним** и не участвует в общей сортировке по длительности (тематический зимний маршрут). При добавлении новых маршрутов вставляйте их перед `ski_ring` в списке карточек и в `ROUTE_ORDER`.

---

## Ключ маршрута (key)

- Латинница, подчёркивание при необходимости: `suzun`, `altai7`, `parabel_kargasok`, `ski_ring`.
- Один и тот же **key** используется в:
  - `data-route="key"` у ссылок в легенде и у блока карты в карточке;
  - `ROUTES[key]` в `routes-maps.js`;
  - `TRACKS[key]` в `build-route-geometries.js`;
  - `ROUTE_GEOMETRIES[key]` после сборки;
  - `ROUTE_INFO[key]` и `ROUTE_ORDER` в `index.html`.

---

## ID секции (sectionId)

- Формат: `route-N-name`, например `route-3-suzun`, `route-10-ski-ring`.
- Должен совпадать с:
  - `id="route-N-name"` у `<article class="route-card">`;
  - `href="#route-N-name"` у пункта в легенде.
- В `ROUTE_INFO[key].sectionId` указывается именно этот id.

---

## Пошаговая инструкция: добавить новый маршрут

### 1. Определить key и sectionId

Выбрать уникальный **key** (например `new_route`) и **sectionId** (например `route-5-new-route`).

### 2. `build-route-geometries.js` — трек для OSRM

В объект **TRACKS** добавить:

```js
new_route: [
  [55.0084, 82.9357],   // Новосибирск (старт)
  [54.5, 83.2],        // Точка 1
  [52.0, 85.0],        // Точка 2
  // …
  [55.0084, 82.9357]   // Новосибирск (финиш, если кольцо)
],
```

- Точки в порядке проезда по маршруту.
- Координаты — **конкретных мест** (ГЛК, заказники, достопримечательности), а не «области вообще» (например, ГЛК «Телецкий», а не просто «Телецкое озеро»).
- Формат: `[широта, долгота]` (как в Leaflet/GeoJSON).

### 3. Сгенерировать геометрию

```bash
cd site/routes
node build-route-geometries.js new_route
```

Для одного маршрута передаётся key; без аргумента пересчитываются все. Требуется интернет (OSRM). Результат пишется в `route-geometries.js`.

### 4. `routes-maps.js` — карта маршрута

В объект **ROUTES** добавить:

```js
new_route: {
  center: [53.5, 84.0],   // центр карты
  zoom: 6,
  track: [
    [55.0084, 82.9357],
    [54.5, 83.2],
    // … тот же порядок, что в TRACKS
  ],
  waypoints: [
    { coords: [54.5, 83.2], title: 'Название точки — краткое описание', type: 'sight' },  // или type: 'stop'
    // …
  ]
},
```

- **track** — те же точки, что в TRACKS (последовательность проезда).
- **waypoints** — маркеры на карте с подсказками; `type`: `'sight'` (достопримечательность) или `'stop'` (стоянка).

### 5. `index.html` — контент и общая карта

**5.1. Легенда** (внутри `#overview-routes-legend`):

```html
<li><a href="#route-5-new-route" data-route="new_route"><span class="legend-swatch" style="background:#XXXXXX"></span><span class="legend-name">Название маршрута</span><span class="legend-days">N дней</span></a></li>
```

Цвет подобрать из палитры или добавить новый hex.

**5.2. ROUTE_INFO** (в скрипте):

```js
new_route: { name: 'Название маршрута', days: 'N дней', sectionId: 'route-5-new-route' }
```

**5.3. ROUTE_ORDER** — добавить key в массив (порядок появления на общей карте и в легенде):

```js
var ROUTE_ORDER = [..., 'new_route'];
```

**5.4. PALETTE** — если маршрутов больше, чем цветов в массиве, добавить цвет в конец (формат `#rrggbb`).

**5.5. Карточка маршрута** — новый блок:

```html
<article class="route-card" id="route-5-new-route">
  <h2>Название маршрута</h2>
  <p class="route-meta"><span class="route-duration-badge">N дней</span> ~XXX км кольцом (или туда-обратно), M дней в дороге. Краткое описание.</p>
  <p>Маршрут: точка A → точка B → …</p>

  <div class="route-schedule">
    <h3>Примерное расписание</h3>
    <ul>
      <li><strong>День 1.</strong> …</li>
      <!-- … -->
    </ul>
  </div>
  <div class="route-stops">
    <h3>Предлагаемые стоянки</h3>
    <ul>…</ul>
  </div>
  <div class="route-sights">
    <h3>Достопримечательности</h3>
    <ul>…</ul>
  </div>
  <div class="route-why">
    <h3>Кому подойдёт</h3>
    <p class="text-muted">…</p>
  </div>

  <div id="map-5-new-route" class="route-map" data-route="new_route"></div>
</article>
```

- В **route-meta обязательно** указать примерное расстояние: «~XXX км кольцом» или «~XXX км туда-обратно» и при необходимости «N дней в дороге».
- `id` у блока карты может быть любым уникальным (часто `map-N-name`); для привязки карты важен только `data-route="new_route"`.

---

## Проверка

1. В легенде клик по новому пункту прокручивает к карточке и подсвечивает линию на общей карте.
2. На общей карте при наведении на линию маршрута показывается тултип с названием и длительностью.
3. В карточке маршрута карта строится по данным из `ROUTES[key]` и при наличии — по `ROUTE_GEOMETRIES[key]` (полилиния по дорогам).
4. Стрелка «К списку маршрутов» ведёт к секции общей карты.

---

## Замечания

- **Координаты** — искать именно объекты (ГЛК, заказники, музеи), а не только населённые пункты или водоёмы.
- **Расстояние** — в каждой карточке в `route-meta` должно быть указано примерное расстояние (и при необходимости время в дороге).
- **route-geometries.js** — только результат работы `build-route-geometries.js`; правки вручную не вносить.
- При добавлении только одного маршрута запускать `node build-route-geometries.js key`, чтобы не перезаписывать геометрии остальных маршрутов (скрипт подгружает существующий `route-geometries.js` и обновляет только указанный key).
