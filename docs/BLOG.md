# Блог: обновление из VK, страницы записей, заголовки

Описание текущей реализации блога: где что лежит, какие скрипты за что отвечают, как обновлять контент и заголовки.

---

## 1. Структура файлов

| Что | Где |
|-----|-----|
| **Записи блога (данные)** | `site/blog/entries/` |
| | `entry_1.json` … `entry_N.json` — JSON поста (текст, дата, vk_url, фото, видео) |
| | `entry_N_1.jpg`, `entry_N_2.jpg` … — скачанные изображения |
| **Страница блога** | `site/blog/index.html` |
| | Первые 10 постов вшиты в HTML (блок между `<!-- BLOG_INITIAL_ENTRIES -->` и `<!-- /BLOG_INITIAL_ENTRIES -->`); остальные подгружаются по скроллу по списку из `BLOG_ENTRIES` |
| **Индивидуальные страницы записей** | `site/blog/entry_{N}_{slug}.html` |
| | Одна страница на запись для SEO и шаринга; slug строится из заголовка (транслит) |
| **Манифест страниц** | `site/blog/entry_pages_manifest.json` |
| | Соответствие «номер записи → имя файла страницы», например `{"136": "entry_136_razdel-marsruty-na-sayte.html"}`. Используется в index.html (`BLOG_ENTRY_PAGES`) и при генерации вшитых постов |
| **Заголовки записей** | `site/blog/entry_titles.json` |
| | Заголовки для slug и title страницы: `{"1": "Медведи как автодома", ...}`. Можно править вручную |
| **Sitemap** | `site/sitemap.xml` |
| | Содержит URL страницы блога и всех индивидуальных страниц записей |

---

## 2. Скрипты (все запускаются из **корня репозитория**)

Токен VK: `VK_ACCESS_TOKEN` в `scripts/.env` или в окружении.

### 2.1. Обычное обновление блога из VK

```bash
python3 scripts/update_blog.py
```

- Берёт **последние 5 постов** из VK.
- Новые посты добавляет (entry_N+1.json, …), изменённые обновляет, исчезнувшие из VK удаляет (включая индивидуальную страницу, манифест и sitemap).
- Обновляет в index.html списки `BLOG_ENTRIES` и `BLOG_ENTRY_PAGES`.
- Запускает `render_blog_entry_pages` для всех непустых записей и `render_blog_initial` (вшитые 10 постов).

После этого по желанию можно вручную подправить заголовки двух последних записей в `entry_titles.json` и заново перегенерировать страницы (см. п. 4).

### 2.2. Индивидуальные страницы записей

```bash
python3 scripts/render_blog_entry_pages.py [N]
```

- Строит HTML-страницы для **N самых свежих непустых записей** (по умолчанию N=5).
- Заголовок берётся из `entry_titles.json` или генерируется по тексту; новые заголовки дописываются в `entry_titles.json`.
- Обновляет `entry_pages_manifest.json`, блок `BLOG_ENTRY_PAGES` в index.html и sitemap.

**Важно:** скрипт при каждом запуске **удаляет из sitemap все URL записей блога** и вставляет только те, что он сгенерировал в этом запуске. Поэтому для «всех записей» нужно передать число не меньше реального количества, например:

```bash
python3 scripts/render_blog_entry_pages.py 200
```

Запуск с малым N (например `2`) приведёт к тому, что в sitemap останутся только две записи блога.

### 2.3. Вшитые посты на странице блога

```bash
python3 scripts/render_blog_initial.py
```

- Перегенерирует блок из 10 вшитых постов в `site/blog/index.html`.
- Ссылки на индивидуальные страницы (дата и т.п.) берёт из `entry_pages_manifest.json`.

Имеет смысл запускать после смены заголовков или после перегенерации страниц записей, чтобы ссылки на `/blog/` вели на актуальные `entry_N_slug.html`.

### 2.4. Полная перекачка ленты из VK

```bash
python3 scripts/fetch_full_blog.py
```

- Очищает `site/blog/entries/`, качает **все** посты стены с пагинацией, сохраняет как entry_1.json … entry_N.json.
- Обновляет в index.html `BLOG_ENTRIES` и `BLOG_ENTRY_PAGES` (по текущему манифесту).
- Запускает только `render_blog_initial` (вшитые 10 постов).

**Не** вызывает `render_blog_entry_pages`. После полной перекачки нужно вручную:

1. Запустить `python3 scripts/render_blog_entry_pages.py 200` — пересоздать все индивидуальные страницы и обновить манифест/sitemap.
2. Запустить `python3 scripts/render_blog_initial.py` — обновить ссылки во вшитых постах.

При смене нумерации записей старые файлы `entry_*_*.html` могут остаться «сиротами» — их можно удалить вручную или оставить (на индекс они не попадут).

---

## 3. Заголовки записей

- **Хранятся в** `site/blog/entry_titles.json`: ключ — номер записи строкой (`"1"`, `"136"` и т.д.), значение — короткий заголовок (2–5 слов).
- **Используются** для: имени файла страницы (slug транслитом), заголовка страницы, хлебных крошек.
- Если для записи в `entry_titles.json` нет ключа, скрипт `render_blog_entry_pages` генерирует заголовок по первому предложению текста и **дописывает** его в `entry_titles.json`.

Ручная правка заголовков:

1. Отредактировать `site/blog/entry_titles.json`.
2. Выполнить:
   ```bash
   python3 scripts/render_blog_entry_pages.py 200
   python3 scripts/render_blog_initial.py
   ```

---

## 4. Типичный сценарий: «обновить блог из VK и подправить заголовки двух последних»

1. Запустить обновление:
   ```bash
   python3 scripts/update_blog.py
   ```
2. Открыть две последние записи (наибольшие N) в `site/blog/entries/entry_N.json`, по смыслу текста придумать заголовки и записать их в `site/blog/entry_titles.json` для этих N.
3. Перегенерировать страницы записей и вшитые посты:
   ```bash
   python3 scripts/render_blog_entry_pages.py 200
   python3 scripts/render_blog_initial.py
   ```

В Cursor для этого сценария есть правило: при просьбе «обновить блог из VK» агент выполняет шаги 1–3, включая генерацию осмысленных заголовков для двух последних записей.

---

## 5. Удаление записи (пост удалён в VK)

При запуске `update_blog.py` скрипт сравнивает последние 5 постов VK с локальными записями. Если пост есть у нас, но его больше нет в VK, выполняется:

- Удаление `entry_N.json` и медиафайлов записи.
- Вызов `render_blog_entry_pages.delete_entry_page(N)`: удаление `entry_N_*.html`, удаление записи из манифеста и из sitemap, обновление `BLOG_ENTRY_PAGES` в index.html.

Ручное удаление одной записи потребовало бы тех же шагов (удалить JSON и медиа, затем вызвать логику delete_entry_page или выполнить её вручную).

---

## 6. Связанные файлы

- План и общая схема VK: `docs/BLOG_VK_PLAN.md`
- Правило для AI «обновление блога из VK + заголовки»: `.cursor/rules/blog-vk-update.mdc`
- Контекст по блогу для AI (скрипты, пути, подводные камни): `.cursor/rules/blog.mdc`
